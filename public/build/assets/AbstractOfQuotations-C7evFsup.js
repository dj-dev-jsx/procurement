import{r as i,j as e,$ as de,m as z}from"./app-93n4-YE1.js";import{A as pe}from"./ApproverLayout-CJpNhpE3.js";import{D as C,a as S,b as _,c as R,d as W,e as O}from"./dialog-dmNlH9AS.js";import{B as a}from"./button-b6E2TuAP.js";import{T as V}from"./textarea-89MP2Dvt.js";import{u as me}from"./toaster-CR_CLjT4.js";import"./Dropdown--SqrWfdR.js";import"./transition-B8_0YiEE.js";import"./XMarkIcon-BajPl_Ya.js";import"./ClipboardDocumentIcon-rUgeVu8g.js";import"./clipboard-check-BUpBKaMS.js";import"./index-DEGu_kMU.js";import"./index-C6Troi14.js";import"./index-BYPC565r.js";import"./circle-check-big-CDYAS76j.js";import"./file-text-BWCkVFPU.js";import"./BellAlertIcon-DQ7YZFl9.js";import"./index-CKryKcUP.js";function Pe({rfq:c,groupedDetails:u={},committee:p}){var J;const l=c.purchase_request,[X,b]=i.useState(!1),[j,g]=i.useState(""),[f,m]=i.useState({open:!1,type:"success",title:"",description:""}),[P,Z]=i.useState({rfqId:null,supplierId:null,detailId:null}),[ee,y]=i.useState(!1),{toast:D}=me(),[d,se]=i.useState(null),[w,$]=i.useState(""),[o,I]=i.useState(c.award_mode??"whole-pr"),[v,te]=i.useState(()=>{const s={};return["secretariat","member1","member2","member3","vice_chair","chair"].forEach(n=>{var h,K;const r=(K=(h=p==null?void 0:p.members)==null?void 0:h.filter(U=>U.position===n))==null?void 0:K.find(U=>U.status==="active");s[n]={name:(r==null?void 0:r.name)||"",status:(r==null?void 0:r.status)||"inactive"}}),{status:(p==null?void 0:p.status)||"draft",members:s}});console.log(v);const[re,N]=i.useState(!1),[L,ne]=i.useState(null),[M,F]=i.useState(!1),[q,A]=i.useState(!1),[H,E]=i.useState(!1),Y=(s,t,n=null)=>{ne({rfqId:s,supplierId:t,detailId:n}),g(""),N(!0)},ie=()=>{A(!0);const s={remarks:j,mode:o,...o==="per-item"?{detail_id:L.detailId}:{}};z.post(route("bac_approver.rollback_winner",{id:L.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{N(!1),A(!1),m({open:!0,type:"success",title:"Rollback Successful",description:"Winner selection has been rolled back."}),D({title:"Rollback Successful",description:"Winner selection has been rolled back.",duration:3e3})},onError:()=>{A(!1),m({open:!0,type:"error",title:"Rollback Failed",description:"Unable to rollback winner. Please try again."})}})},ae=s=>window.open(route("bac_approver.print_aoq",{id:s}),"_blank"),le=(s,t)=>window.open(route("bac_approver.print_aoq",{id:s,pr_detail_id:t}),"_blank"),G=(s,t,n=null)=>{Z({rfqId:s,supplierId:t,detailId:n}),g(""),b(!0)},oe=()=>{E(!0);const s={supplier_id:P.supplierId,remarks:j,mode:o,...o==="per-item"?{detail_id:P.detailId}:{}};z.post(route("bac_approver.mark_winner",{id:P.rfqId}),s,{preserveScroll:!0,onSuccess:()=>{b(!1),E(!1),m({open:!0,type:"success",title:"Winner Marked",description:o==="per-item"?"Supplier has been awarded for the selected item.":"Supplier has been awarded for the entire PR."}),D({title:"Winner Marked",description:o==="per-item"?"Supplier has been awarded for the selected item.":"Supplier has been awarded for the entire PR.",duration:3e3})},onError:()=>{E(!1),m({open:!0,type:"error",title:"Failed to Mark Winner",description:"Something went wrong while marking the winner. Please try again."})}})},x={},k={};l.details.forEach(s=>{(u[s.id]||[]).forEach(n=>{const r=n.supplier.id;x[r]||(x[r]={supplier:n.supplier,detailIds:new Set,total:0},k[r]=0),x[r].detailIds.add(s.id),x[r].total+=parseFloat(n.quoted_price||0),n.is_winner&&k[r]++})});const B=l.details.length,Q=Object.values(x).filter(s=>s.detailIds.size===B),T=Q.length>0;i.useEffect(()=>{!T&&o==="whole-pr"&&I("per-item")},[T,o]);const ce=l.details.some(s=>(u[s.id]||[]).some(t=>t.is_winner));return Object.values(k).some(s=>s===B),l.details.some(s=>(u[s.id]||[]).some(t=>t.is_winner)),e.jsxs(pe,{children:[e.jsx(de,{title:`Abstract for ${l.pr_number}`}),e.jsxs("div",{className:"px-8 py-10",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-6",children:["Abstract of Quotations â€“ PR #",l.pr_number]}),e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsx("button",{onClick:()=>window.history.back(),className:"inline-flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-md text-sm shadow-sm",children:"â† Back"})}),e.jsxs("div",{className:"mb-6 flex gap-4",children:[e.jsx(a,{variant:o==="whole-pr"?"default":"outline",onClick:()=>I("whole-pr"),disabled:!!c.award_mode,children:"Winner for Entire PR"}),e.jsx(a,{variant:o==="per-item"?"default":"outline",onClick:()=>I("per-item"),disabled:!!c.award_mode,children:"Winner per Item"})]}),!T&&e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"âš ï¸ No supplier quoted for all items. You can only declare winners per item."}),o==="whole-pr"&&e.jsxs("div",{className:"mb-10 border p-4 rounded-lg bg-white shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-start p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comparison for Entire Purchase Request"}),e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Focal Person:"})," ",l.focal_person.firstname," ",l.focal_person.lastname]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Division:"})," ",l.division.division]})]}),Q.length===1&&e.jsx("p",{className:"mt-2 text-sm text-orange-600 font-medium",children:"âš ï¸ Note: Only one supplier submitted quotes for the entire PR."})]}),e.jsx("button",{onClick:()=>ae(c.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md h-fit",children:"ðŸ–¨ï¸ Print Full AOQ"})]}),e.jsxs("table",{className:"w-full text-sm border",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-4 py-2",children:"Supplier"}),l.details.map(s=>e.jsx("th",{className:"border px-2 py-2 text-center text-xs",children:s.item},s.id)),e.jsx("th",{className:"border px-4 py-2 text-right",children:"Total Quoted Price"}),e.jsx("th",{className:"border px-4 py-2 text-center",children:"Winner"})]})}),e.jsx("tbody",{children:Q.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-4 py-2",children:s.supplier.company_name}),l.details.map(t=>{const r=(u[t.id]||[]).find(h=>h.supplier.id===s.supplier.id);return e.jsx("td",{className:"border px-2 py-1 text-center",children:r?`â‚±${parseFloat(r.quoted_price).toLocaleString()}`:"â€”"},t.id)}),e.jsxs("td",{className:"border px-4 py-2 text-right",children:["â‚±",parseFloat(s.total).toLocaleString()]}),e.jsx("td",{className:"border px-4 py-2 text-center",children:k[s.supplier.id]===B?e.jsxs(e.Fragment,{children:["âœ”ï¸",e.jsx(a,{size:"sm",variant:"destructive",className:"ml-2",onClick:()=>Y(c.id,s.supplier.id),children:"Rollback"})]}):ce?"â€”":e.jsx(a,{size:"sm",onClick:()=>G(c.id,s.supplier.id),children:"Mark as Winner"})})]},s.supplier.id))})]})]}),o==="per-item"&&e.jsx("div",{className:"space-y-8 mb-10 border p-4 rounded-lg bg-white shadow-sm",children:l.details.map(s=>{const t=u[s.id]||[],n=t.some(r=>r.is_winner);return e.jsxs("div",{className:"border p-4 bg-white rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h4",{className:"font-semibold",children:s.item}),e.jsx("button",{onClick:()=>le(c.id,s.id),className:"text-sm text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md",children:"ðŸ–¨ï¸ Print AOQ"})]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[e.jsx("strong",{children:"Description:"})," ",s.specs||"â€”"," ",e.jsx("br",{}),e.jsx("strong",{children:"Quantity:"})," ",s.quantity," ",s.unit," ",e.jsx("br",{})]}),e.jsxs("table",{className:"w-full text-sm border rounded-lg overflow-hidden",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Supplier"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Quoted Price"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Winner"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:t.map((r,h)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2",children:r.supplier.company_name}),e.jsxs("td",{className:"px-4 py-2 text-right",children:["â‚±",parseFloat(r.quoted_price||0).toLocaleString()]}),e.jsx("td",{className:"px-4 py-2 text-center",children:r.is_winner?e.jsxs("div",{className:"flex justify-center items-center gap-2",children:[e.jsx("span",{className:"text-green-600 font-bold",children:"âœ”ï¸"}),e.jsx(a,{size:"sm",variant:"destructive",onClick:()=>Y(c.id,r.supplier.id,s.id),children:"Rollback"})]}):n?e.jsx("span",{className:"text-gray-400",children:"â€”"}):e.jsx(a,{size:"sm",onClick:()=>G(c.id,r.supplier.id,s.id),children:"Mark as Winner"})})]},h))})]})]},s.id)})}),e.jsxs("div",{className:"mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"BAC Committee"}),e.jsx("ul",{className:"space-y-3",children:["chair","vice_chair","secretariat","member1","member2","member3"].map(s=>{const t=v.members[s];return(t==null?void 0:t.status)==="active"&&e.jsxs("li",{className:"flex items-center justify-between bg-white p-3 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.name||"â€”"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.replace("_"," ").toUpperCase()})]}),e.jsx(a,{variant:"outline",size:"sm",onClick:()=>{se({position:s,current:t}),$(""),y(!0)},children:"Replace"})]},s)})})]})]}),e.jsx(C,{open:X,onOpenChange:b,children:e.jsxs(S,{children:[e.jsxs(_,{children:[e.jsx(R,{children:"Confirm Winner"}),e.jsx(W,{children:"Provide remarks for awarding this supplier."})]}),e.jsx(V,{value:j,onChange:s=>g(s.target.value)}),e.jsxs(O,{children:[e.jsx(a,{variant:"secondary",onClick:()=>b(!1),children:"Cancel"}),e.jsx(a,{disabled:H,onClick:oe,children:H?"Confirming Winner...":"Confirm"})]})]})}),e.jsx(C,{open:ee,onOpenChange:y,children:e.jsxs(S,{className:"sm:max-w-md",children:[e.jsxs(_,{children:[e.jsx(R,{children:"Replace Committee Member"}),e.jsxs(W,{children:["Enter a new member to replace"," ",e.jsx("strong",{children:((J=d==null?void 0:d.current)==null?void 0:J.name)||"N/A"})," (",d==null?void 0:d.position.replace("_"," ").toUpperCase(),")."]})]}),e.jsx("input",{type:"text",value:w,onChange:s=>$(s.target.value),placeholder:"Enter new member name",className:"w-full border px-3 py-2 rounded mb-2"}),e.jsxs(O,{className:"mt-4",children:[e.jsx(a,{variant:"secondary",onClick:()=>y(!1),children:"Cancel"}),e.jsx(a,{disabled:M,onClick:()=>{if(!w.trim())return;F(!0),te(t=>({...t,members:{...t.members,[d.position]:{name:w.trim(),status:"active"}}}));const s={id:(p==null?void 0:p.id)??null,status:v.status,members:Object.entries({...v.members,[d.position]:{name:w.trim(),status:"active"}}).map(([t,n])=>({position:t,name:n.name,status:n.status}))};z.post(route("bac.committee.save"),s,{preserveScroll:!0,onSuccess:()=>{F(!1),y(!1),m({open:!0,type:"success",title:"Committee Updated",description:`${d.position.replace("_"," ")} replaced successfully.`}),D({title:"Committee Updated",description:`${d.position.replace("_"," ")} replaced successfully.`,duration:3e3})},onError:()=>{F(!1),m({open:!0,type:"error",title:"Committee Update Failed",description:"Unable to replace committee member. Please try again."})}})},children:M?"Saving...":"Confirm"})]})]})}),e.jsx(C,{open:re,onOpenChange:N,children:e.jsxs(S,{children:[e.jsxs(_,{children:[e.jsx(R,{children:"Rollback Winner"}),e.jsx(W,{children:"Provide remarks for rolling back this winner selection."})]}),e.jsx(V,{value:j,onChange:s=>g(s.target.value)}),e.jsxs(O,{children:[e.jsx(a,{variant:"secondary",onClick:()=>N(!1),children:"Cancel"}),e.jsx(a,{disabled:q,variant:"destructive",onClick:ie,children:q?"Rolling Back Winner...":"Confirm Rollback"})]})]})}),e.jsx(C,{open:f.open,onOpenChange:s=>m(t=>({...t,open:s})),children:e.jsxs(S,{children:[e.jsxs(_,{children:[e.jsx(R,{className:f.type==="error"?"text-red-600":"text-green-600",children:f.title}),e.jsx(W,{children:f.description})]}),e.jsx(O,{children:e.jsx(a,{onClick:()=>m(s=>({...s,open:!1})),children:"Close"})})]})})]})}export{Pe as default};
